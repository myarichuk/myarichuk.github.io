<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Listening to data changes in PostgreSQL and C# | Graymatter Developer</title><meta name="author" content="Michael Yarichuk"><meta name="copyright" content="Michael Yarichuk"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="To poll or not to poll?Nowadays, fast, responsive UI that reacts to data changes is pretty much a given (well, not always, yes, but often enough to talk about it!). If it is an application with just o">
<meta property="og:type" content="article">
<meta property="og:title" content="Listening to data changes in PostgreSQL and C#">
<meta property="og:url" content="https://www.graymatterdeveloper.com/2019/12/02/listening-events-postgresql/index.html">
<meta property="og:site_name" content="Graymatter Developer">
<meta property="og:description" content="To poll or not to poll?Nowadays, fast, responsive UI that reacts to data changes is pretty much a given (well, not always, yes, but often enough to talk about it!). If it is an application with just o">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/1473701">
<meta property="article:published_time" content="2019-12-02T09:23:25.000Z">
<meta property="article:modified_time" content="2019-12-02T09:23:25.000Z">
<meta property="article:author" content="Michael Yarichuk">
<meta property="article:tag" content="C#">
<meta property="article:tag" content="PostgreSQL">
<meta property="article:tag" content="SQL">
<meta property="article:tag" content="Event-handling">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://avatars.githubusercontent.com/u/1473701"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://www.graymatterdeveloper.com/2019/12/02/listening-events-postgresql/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-125949801-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-125949801-1');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Listening to data changes in PostgreSQL and C#',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2019-12-02 09:23:25'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Graymatter Developer" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/1473701" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">30</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tag"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fa fa-envelope-open"></i><span> Contact</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2019/12/02/listening-events-postgresql/top.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Graymatter Developer"><span class="site-name">Graymatter Developer</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tag"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fa fa-envelope-open"></i><span> Contact</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Listening to data changes in PostgreSQL and C#</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2019-12-02T09:23:25.000Z" title="Created 2019-12-02 09:23:25">2019-12-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2019-12-02T09:23:25.000Z" title="Updated 2019-12-02 09:23:25">2019-12-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Programming/">Programming</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Programming/Databases/">Databases</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Listening to data changes in PostgreSQL and C#"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="To-poll-or-not-to-poll"><a href="#To-poll-or-not-to-poll" class="headerlink" title="To poll or not to poll?"></a>To poll or not to poll?</h3><p>Nowadays, fast, responsive UI that reacts to data changes is pretty much a given (well, not always, yes, but often enough to talk about it!). If it is an application with just one user it is not that hard to implement, but what if there are multiple users in a system that affect each other?<br>The answer would be… not to poll if you can, because more often than not there is another, better way. Many databases, both NoSQL and RDBMS offer functionality to push events to the connected clients.  </p>
<h3 id="So-what-are-we-doing-in-this-post"><a href="#So-what-are-we-doing-in-this-post" class="headerlink" title="So, what are we doing in this post?"></a>So, what are we doing in this post?</h3><p>RavenDB has awesome feature called <a target="_blank" rel="noopener" href="https://ravendb.net/docs/article-page/4.2/csharp/client-api/data-subscriptions/what-are-data-subscriptions">Data Subscriptions</a>, which allow its client-api to receive near real-time notifications and changed data.<br>I was curious to see how such feature works in other databases. The following is the result of my tinkering with PostgreSQL, I tried (and succeeded!) making PostgreSQL C# driver to receive events of any change of data in the database.</p>
<h3 id="Setting-the-server-side-to-send-notifications-about-data-changes"><a href="#Setting-the-server-side-to-send-notifications-about-data-changes" class="headerlink" title="Setting the server-side to send notifications about data changes"></a>Setting the server-side to send notifications about data changes</h3><p>In order to set up change event listening, I will be using <a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/12/sql-notify.html">NOTIFY</a>)/<a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/12/sql-listen.html">LISTEN</a> commands.</p>
<h4 id="Setting-up-the-database"><a href="#Setting-up-the-database" class="headerlink" title="Setting up the database"></a>Setting up the database</h4><p>I installed the latest version PostgreSQL server at the time of writing, version 12. (But you don’t have to use version 12 - from what I’ve read, the following SQL code should work for any PostgreSQL that supports JSON natively)<br>As a test dataset I have used a Northwind database from <a target="_blank" rel="noopener" href="https://github.com/pthom/northwind_psql">this repository</a>, but any dataset can be used, really.</p>
<h4 id="A-function-that-will-be-used-in-change-triggers"><a href="#A-function-that-will-be-used-in-change-triggers" class="headerlink" title="A function that will be used in change triggers"></a>A function that will be used in change triggers</h4><p>Any table we want to watch for changes in its data would have a trigger that would “forward” the change to a function that would use <a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/12/sql-notify.html">NOTIFY statement</a> to listening clients.<br>The following is such function:  </p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> <span class="built_in">public</span>.&quot;NotifyOnDataChange&quot;()</span><br><span class="line">  <span class="keyword">RETURNS</span> <span class="type">trigger</span></span><br><span class="line">  <span class="keyword">LANGUAGE</span> <span class="string">&#x27;plpgsql&#x27;</span></span><br><span class="line"><span class="keyword">AS</span> $BODY$ </span><br><span class="line"><span class="keyword">DECLARE</span> </span><br><span class="line">  data <span class="type">JSON</span>;</span><br><span class="line">  notification <span class="type">JSON</span>;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="comment">-- if we delete, then pass the old data</span></span><br><span class="line">  <span class="comment">-- if we insert or update, pass the new data</span></span><br><span class="line">  <span class="keyword">IF</span> (<span class="built_in">TG_OP</span> = <span class="string">&#x27;DELETE&#x27;</span>) <span class="keyword">THEN</span></span><br><span class="line">    data = row_to_json(<span class="built_in">OLD</span>);</span><br><span class="line">  <span class="keyword">ELSE</span></span><br><span class="line">    data = row_to_json(<span class="built_in">NEW</span>);</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- create json payload</span></span><br><span class="line">  <span class="comment">-- note that here can be done projection </span></span><br><span class="line">  notification = json_build_object(</span><br><span class="line">            <span class="string">&#x27;table&#x27;</span>,<span class="built_in">TG_TABLE_NAME</span>,</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span>, <span class="built_in">TG_OP</span>, <span class="comment">-- can have value of INSERT, UPDATE, DELETE</span></span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>, data);  </span><br><span class="line">            </span><br><span class="line">    <span class="comment">-- note that channel name MUST be lowercase, otherwise pg_notify() won&#x27;t work</span></span><br><span class="line">    <span class="keyword">PERFORM</span> pg_notify(<span class="string">&#x27;datachange&#x27;</span>, notification::<span class="type">TEXT</span>);</span><br><span class="line">  <span class="keyword">RETURN</span> <span class="built_in">NEW</span>;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$BODY$;</span><br></pre></td></tr></table></figure>

<h4 id="Change-triggers"><a href="#Change-triggers" class="headerlink" title="Change triggers"></a>Change triggers</h4><p>Now, we will set up triggers to wire change events with <strong>NotifyOnDataChange</strong> function.</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> &quot;OnDataChange&quot;</span><br><span class="line">  <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">OR</span> <span class="keyword">DELETE</span> <span class="keyword">OR</span> <span class="keyword">UPDATE</span> </span><br><span class="line">  <span class="keyword">ON</span> <span class="built_in">public</span>.orders</span><br><span class="line">  <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line">  <span class="keyword">EXECUTE</span> <span class="keyword">PROCEDURE</span> <span class="built_in">public</span>.&quot;NotifyOnDataChange&quot;();</span><br></pre></td></tr></table></figure>
<p>That is nice, but what if we want notifications from all of the tables in the database?<br>The following function will iterate over all tables and create triggers in each of them</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> <span class="built_in">public</span>.&quot;CreateOnDataChangeForAllTables&quot;()</span><br><span class="line">  <span class="keyword">RETURNS</span> <span class="type">void</span></span><br><span class="line">  <span class="keyword">LANGUAGE</span> <span class="string">&#x27;plpgsql&#x27;</span></span><br><span class="line"><span class="keyword">AS</span> $BODY$</span><br><span class="line"><span class="keyword">DECLARE</span>  </span><br><span class="line">  createTriggerStatement <span class="type">TEXT</span>;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">FOR</span> createTriggerStatement <span class="keyword">IN</span> <span class="keyword">SELECT</span></span><br><span class="line">    <span class="string">&#x27;CREATE TRIGGER OnDataChange AFTER INSERT OR DELETE OR UPDATE ON &#x27;</span></span><br><span class="line">    || tab_name</span><br><span class="line">    || <span class="string">&#x27; FOR EACH ROW EXECUTE PROCEDURE public.&quot;NotifyOnDataChange&quot;();&#x27;</span> <span class="keyword">AS</span> trigger_creation_query</span><br><span class="line">  <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">      quote_ident(table_schema) || <span class="string">&#x27;.&#x27;</span> || quote_ident(<span class="built_in">table_name</span>) <span class="keyword">as</span> tab_name</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">      information_schema.<span class="keyword">tables</span></span><br><span class="line">    <span class="keyword">WHERE</span></span><br><span class="line">      table_schema <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">&#x27;pg_catalog&#x27;</span>, <span class="string">&#x27;information_schema&#x27;</span>)</span><br><span class="line">      <span class="keyword">AND</span> table_schema <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;pg_toast%&#x27;</span></span><br><span class="line">  ) <span class="keyword">as</span> TableNames</span><br><span class="line">  <span class="keyword">LOOP</span></span><br><span class="line">    <span class="keyword">EXECUTE</span>  createTriggerStatement; <span class="comment">--actually create the trigger</span></span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line"><span class="keyword">END</span>$BODY$;</span><br></pre></td></tr></table></figure>

<p>That’s it! The server-side is ready to send notifications for data changes.</p>
<h3 id="Setting-up-PostgreSQL-client-to-receive-events"><a href="#Setting-up-PostgreSQL-client-to-receive-events" class="headerlink" title="Setting-up PostgreSQL client to receive events"></a>Setting-up PostgreSQL client to receive events</h3><p>For a client test app, I used .Net Core 3.0 project with <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/Npgsql/4.1.2">Npgsql data provider</a>.<br>The following is code for listening for data changes.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">string</span> connString = <span class="string">&quot;&lt;connection string&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">using</span> <span class="keyword">var</span> conn = <span class="keyword">new</span> NpgsqlConnection(connString);</span><br><span class="line">    <span class="keyword">await</span> conn.OpenAsync();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//e.Payload is string representation of JSON we constructed in NotifyOnDataChange() function</span></span><br><span class="line">    conn.Notification += (o, e) =&gt; Console.WriteLine(<span class="string">&quot;Received notification: &quot;</span> + e.Payload);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">using</span> (<span class="keyword">var</span> cmd = <span class="keyword">new</span> NpgsqlCommand(<span class="string">&quot;LISTEN datachange;&quot;</span>, conn))</span><br><span class="line">      cmd.ExecuteNonQuery();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) </span><br><span class="line">      conn.Wait(); <span class="comment">// wait for events</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There we have it. A simple way to listen for changes in PostgreSQL.<br>Note, if the NpgsqlConnection client is not connected and changes happen, data change event will obviously be missed. Considering that RavenDB’s <a target="_blank" rel="noopener" href="https://ravendb.net/docs/article-page/4.2/csharp/client-api/data-subscriptions/what-are-data-subscriptions">Data Subscriptions</a> allow handling “missed” events as well, I consider this a flaw of PostgreSQL notifications feature.</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C#</a><a class="post-meta__tags" href="/tags/PostgreSQL/">PostgreSQL</a><a class="post-meta__tags" href="/tags/SQL/">SQL</a><a class="post-meta__tags" href="/tags/Event-handling/">Event-handling</a></div><div class="post_share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a></div></div><script async="async" src="https://static.addtoany.com/menu/page.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/12/05/async-sync/" title="Synchronization primitives + async/await = trouble"><img class="cover" src="/2019/12/05/async-sync/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Synchronization primitives + async/await = trouble</div></div></a></div><div class="next-post pull-right"><a href="/2019/11/28/hello-world-microservices/" title="Hello World with multiple microservices"><img class="cover" src="/2019/11/28/hello-world-microservices/microservices.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Hello World with multiple microservices</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/1473701" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Michael Yarichuk</div><div class="author-info__description">A place to share steps in my journey to become a better professional</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">30</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/myarichuk"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/myarichuk" target="_blank" title=""><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:michael.yarichuk@gmail.com" target="_blank" title=""><i class="fa fa-envelope"></i></a><a class="social-icon" href="https://twitter.com/myarichuk" target="_blank" title=""><i class="fa-brands fa-twitter"></i></a><a class="social-icon" href="https://www.linkedin.com/in/myarichuk/" target="_blank" title=""><i class="fa-brands fa-linkedin"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fa fa-rss"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#To-poll-or-not-to-poll"><span class="toc-number">1.</span> <span class="toc-text">To poll or not to poll?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#So-what-are-we-doing-in-this-post"><span class="toc-number">2.</span> <span class="toc-text">So, what are we doing in this post?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Setting-the-server-side-to-send-notifications-about-data-changes"><span class="toc-number">3.</span> <span class="toc-text">Setting the server-side to send notifications about data changes</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Setting-up-the-database"><span class="toc-number">3.1.</span> <span class="toc-text">Setting up the database</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#A-function-that-will-be-used-in-change-triggers"><span class="toc-number">3.2.</span> <span class="toc-text">A function that will be used in change triggers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Change-triggers"><span class="toc-number">3.3.</span> <span class="toc-text">Change triggers</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Setting-up-PostgreSQL-client-to-receive-events"><span class="toc-number">4.</span> <span class="toc-text">Setting-up PostgreSQL client to receive events</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/11/15/production-ready-memory-dumps/" title="'Production Ready' Non-Negotiable: Memory Dump Tooling"><img src="/2023/11/15/production-ready-memory-dumps/production-ready-memory-dump.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="'Production Ready' Non-Negotiable: Memory Dump Tooling"/></a><div class="content"><a class="title" href="/2023/11/15/production-ready-memory-dumps/" title="'Production Ready' Non-Negotiable: Memory Dump Tooling">'Production Ready' Non-Negotiable: Memory Dump Tooling</a><time datetime="2023-11-15T22:19:28.000Z" title="Created 2023-11-15 22:19:28">2023-11-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/15/production-ready-performance-metrics/" title="'Production Ready' Non-Negotiable: Performance Metrics"><img src="/2023/11/15/production-ready-performance-metrics/production-ready-performance.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="'Production Ready' Non-Negotiable: Performance Metrics"/></a><div class="content"><a class="title" href="/2023/11/15/production-ready-performance-metrics/" title="'Production Ready' Non-Negotiable: Performance Metrics">'Production Ready' Non-Negotiable: Performance Metrics</a><time datetime="2023-11-15T17:43:55.000Z" title="Created 2023-11-15 17:43:55">2023-11-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/14/production-ready-logging-monitoring/" title="'Production Ready' Non-Negotiable: Structured Logging and Monitoring"><img src="/2023/11/14/production-ready-logging-monitoring/production-ready-2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="'Production Ready' Non-Negotiable: Structured Logging and Monitoring"/></a><div class="content"><a class="title" href="/2023/11/14/production-ready-logging-monitoring/" title="'Production Ready' Non-Negotiable: Structured Logging and Monitoring">'Production Ready' Non-Negotiable: Structured Logging and Monitoring</a><time datetime="2023-11-14T23:00:00.000Z" title="Created 2023-11-14 23:00:00">2023-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/14/production-ready-intro/" title="Production-Ready Software: Introduction"><img src="/2023/11/14/production-ready-intro/production_ready_background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Production-Ready Software: Introduction"/></a><div class="content"><a class="title" href="/2023/11/14/production-ready-intro/" title="Production-Ready Software: Introduction">Production-Ready Software: Introduction</a><time datetime="2023-11-14T19:15:48.000Z" title="Created 2023-11-14 19:15:48">2023-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/10/responsibility-chain/" title="Taming Complexity with Responsibility"><img src="/2023/11/10/responsibility-chain/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Taming Complexity with Responsibility"/></a><div class="content"><a class="title" href="/2023/11/10/responsibility-chain/" title="Taming Complexity with Responsibility">Taming Complexity with Responsibility</a><time datetime="2023-11-10T23:00:00.000Z" title="Created 2023-11-10 23:00:00">2023-11-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Michael Yarichuk</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.graymatterdeveloper.com/2019/12/02/listening-events-postgresql/'
    this.page.identifier = '/2019/12/02/listening-events-postgresql/'
    this.page.title = 'Listening to data changes in PostgreSQL and C#'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://graymatterdeveloperblog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-R5G4WP4QCQ"></script><script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-R5G4WP4QCQ') </script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>