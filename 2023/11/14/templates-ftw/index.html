<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Disentangling the Spaghetti Monster | Graymatter Developer</title><meta name="author" content="Michael Yarichuk"><meta name="copyright" content="Michael Yarichuk"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="In this blog post, we will explore the practical application of a specific design pattern. To illustrate its usefulness, we will gradually reveal the problem in an “organic” manner, simulating how one">
<meta property="og:type" content="article">
<meta property="og:title" content="Disentangling the Spaghetti Monster">
<meta property="og:url" content="https://www.graymatterdeveloper.com/2023/11/14/templates-ftw/index.html">
<meta property="og:site_name" content="Graymatter Developer">
<meta property="og:description" content="In this blog post, we will explore the practical application of a specific design pattern. To illustrate its usefulness, we will gradually reveal the problem in an “organic” manner, simulating how one">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.graymatterdeveloper.com/2023/11/14/templates-ftw/cover.png">
<meta property="article:published_time" content="2023-11-14T00:25:27.123Z">
<meta property="article:modified_time" content="2023-11-14T00:25:27.123Z">
<meta property="article:author" content="Michael Yarichuk">
<meta property="article:tag" content="C#">
<meta property="article:tag" content="Architecture">
<meta property="article:tag" content="Programming">
<meta property="article:tag" content="Design Patterns">
<meta property="article:tag" content="Gang Of Four">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.graymatterdeveloper.com/2023/11/14/templates-ftw/cover.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://www.graymatterdeveloper.com/2023/11/14/templates-ftw/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-125949801-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-125949801-1');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Disentangling the Spaghetti Monster',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-11-14 00:25:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Graymatter Developer" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/1473701" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tag"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fa fa-envelope-open"></i><span> Contact</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2023/11/14/templates-ftw/top.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Graymatter Developer"><span class="site-name">Graymatter Developer</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tag"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fa fa-envelope-open"></i><span> Contact</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Disentangling the Spaghetti Monster</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-11-14T00:25:27.123Z" title="Created 2023-11-14 00:25:27">2023-11-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-11-14T00:25:27.123Z" title="Updated 2023-11-14 00:25:27">2023-11-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Programming/">Programming</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Programming/Design-Patterns/">Design Patterns</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Disentangling the Spaghetti Monster"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>In this blog post, we will explore the practical application of a specific design pattern. To illustrate its usefulness, we will gradually reveal the problem in an “organic” manner, simulating how one might encounter such an issue in their daily programming tasks.</p>
<h2 id="The-What-and-Why"><a href="#The-What-and-Why" class="headerlink" title="The What and Why"></a>The What and Why</h2><p>Picture this: you’re working on a music streaming platform, and you already implemented live and offline playback, search functionality, and user ratings. The last piece of the puzzle? Playlist suggestions based on user preferences.<br>Seems simple, right? Just do some simple aggregations over likes and dislikes to figure out what genres of music the user is into, and serve up some recommendations based on that. So you decide to implement just that.</p>
<h2 id="The-How"><a href="#The-How" class="headerlink" title="The How"></a>The How</h2><p>Let’s assume our data is defined by the following entities.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> MusicGenre</span><br><span class="line">&#123;</span><br><span class="line">    Rock,</span><br><span class="line">    Classical,</span><br><span class="line">    HipHop,</span><br><span class="line">    <span class="comment">// more genres omitted for clarity</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//for each track with &quot;like&quot; or &quot;dislike&quot;, create this</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title">Vote</span>(<span class="params"><span class="built_in">string</span> TrackId, <span class="built_in">string</span> UserId, <span class="built_in">bool</span> IsUpvoted</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Track is the most generic name I could think of :)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title">Track</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span> Id,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span> ArtistId,</span></span></span><br><span class="line"><span class="params"><span class="function">    MusicGenre Genre, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span> Name</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, let’s see how will the implementation look like. First, for simplicity’s sake, we will use Entity Framework and encapsulate access to track and votes data via the repository pattern.  </p>
<blockquote>
<p>Note: error and edge case handling are omitted for clarity and also, let’s assume the calling code handles opening and commit/rollback of transactions as needed</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//simplistic implementation of data access</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TrackRepository</span> : <span class="title">ITrackRepository</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> DbSet&lt;Track&gt; _tracks;</span><br><span class="line">  <span class="comment">//ctor omitted for clarity</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//fetch tracks specified by a list of track IDs</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IReadOnlyList&lt;Track&gt; <span class="title">FetchByIDs</span>(<span class="params">IEnumerable&lt;<span class="built_in">string</span>&gt; trackIdsToFind</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//in this case, EF generates IN statement in the WHERE clause</span></span><br><span class="line">    <span class="keyword">return</span> _tracks.Where(track =&gt; trackIdsToFind.Contains(track.Id))</span><br><span class="line">                  .ToList();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//fetch a list of random tracks filtered by specified genre list</span></span><br><span class="line">  <span class="comment">//note: we selected 100 as max fetch count arbitrarily, obviously this should be configurable</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IReadOnlyList&lt;Track&gt; <span class="title">FetchRandomByGenres</span>(<span class="params">IEnumerable&lt;MusicGenre&gt; genres, <span class="built_in">int</span> maxTracksToFetch = <span class="number">100</span></span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//in this case, EF generates IN statement in the WHERE clause</span></span><br><span class="line">    <span class="keyword">return</span> _tracks.Where(track =&gt; genres.Contains(track.Genre))</span><br><span class="line">                  .OrderBy(track =&gt; Guid.NewGuid()) <span class="comment">//ensure randomness :)</span></span><br><span class="line">                  .Take(maxTracksToFetch)</span><br><span class="line">                  .ToList();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VoteRepository</span>: <span class="title">IVoteRepository</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> DbSet&lt;Vote&gt; _votes;</span><br><span class="line">  <span class="comment">//ctor omitted for clarity</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IReadOnlyList&lt;Vote&gt; <span class="title">FetchUpvotesFor</span>(<span class="params"><span class="built_in">string</span> userId</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> _votes.Where(vote =&gt; vote.UserId == userId &amp;&amp; </span><br><span class="line">                                vote.IsUpvoted == <span class="literal">true</span>)</span><br><span class="line">                 .ToList();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Now, the class actually generating the playlist, would look something like this.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlaylistRecommenderByGenrePreferences</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> ITrackRepository _trackRepo;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IVoteRepository _voteRepo;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ctor omitted for clarity</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IEnumerable&lt;Track&gt; <span class="title">FetchRecommendationFor</span>(<span class="params"><span class="built_in">string</span> userId</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//first fetch all the votes and aggregate them</span></span><br><span class="line">    <span class="keyword">var</span> userVotes = _voteRepo.FetchUpvotesFor(userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//fetch all upvoted tracks</span></span><br><span class="line">    <span class="keyword">var</span> upvotedTracks = _trackRepo.FetchByIDs(userVotes.Select(v =&gt; v.TrackId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//count how many times each track was upvoted</span></span><br><span class="line">    <span class="keyword">var</span> groupedByGenre = upvotedTracks</span><br><span class="line">        .GroupBy(x =&gt; x.Genre)</span><br><span class="line">        .Select(x =&gt; </span><br><span class="line">            <span class="keyword">new</span></span><br><span class="line">            &#123;</span><br><span class="line">                Genre = x.Key, </span><br><span class="line">                Count = x.Count()</span><br><span class="line">            &#125;)</span><br><span class="line">        .OrderByDescending(x =&gt; x.Count);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//take the first three most liked genres</span></span><br><span class="line">    <span class="keyword">var</span> mostLikedGenres = </span><br><span class="line">        groupedByGenre</span><br><span class="line">            .Take(<span class="number">3</span>)</span><br><span class="line">            .Select(x =&gt; x.Genre);    </span><br><span class="line"></span><br><span class="line">    <span class="comment">//now get some random tracks for genres the user likes</span></span><br><span class="line">    <span class="keyword">return</span> _trackRepo.FetchRandomByGenres(mostLikedGenres);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After we have a simple but functional implementation of random playlist generation is implemented, the new system goes live. Everything works well, and then, after a while, users another way to generate a playlist by artist that play the music user liked - sort of “more of the same”.  </p>
<p>Okay, I might hear you say, that is not that hard. Simply aggregate artists that created the music users liked and fetch more from the same artists.<br>We can start from adding another method to <code>TrackRepository</code></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//fetch some random tracks from the same artist</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IReadOnlyList&lt;Track&gt; <span class="title">FetchRandomByArtist</span>(<span class="params">IEnumerable&lt;<span class="built_in">string</span>&gt; artistIds</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> _tracks.Where(track =&gt; artistIds.Contains(track.ArtistId))</span><br><span class="line">                .OrderBy(Guid.NewGuid())</span><br><span class="line">                .ToList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Next piece of the puzzle would be to implement the new playlist generator. As we can see, the implementation would be similar to “by genre” playlist generator but different enough that we can’t reuse the same method.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlaylistRecommenderByArtistPreferences</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> ITrackRepository _trackRepo;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IVoteRepository _voteRepo;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">PlaylistRecommenderByArtistPreferences</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    ITrackRepository trackRepo, </span></span></span><br><span class="line"><span class="params"><span class="function">    IVoteRepository voteRepo</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    _trackRepo = trackRepo;</span><br><span class="line">    _voteRepo = voteRepo;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IEnumerable&lt;Track&gt; <span class="title">FetchRecommendationFor</span>(<span class="params"><span class="built_in">string</span> userId</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//first fetch all the votes and aggregate them</span></span><br><span class="line">    <span class="keyword">var</span> userVotes = _voteRepo.FetchUpvotesFor(userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//fetch all upvoted tracks</span></span><br><span class="line">    <span class="keyword">var</span> upvotedTracks = _trackRepo.FetchByIDs(userVotes.Select(v =&gt; v.TrackId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//now aggregate by artistID</span></span><br><span class="line">    <span class="keyword">var</span> groupedByArtists = upvotedTracks</span><br><span class="line">        .GroupBy(x =&gt; x.ArtistId)</span><br><span class="line">        .Select(x =&gt; </span><br><span class="line">            <span class="keyword">new</span></span><br><span class="line">            &#123;</span><br><span class="line">                ArtistId = x.Key, </span><br><span class="line">                Count = x.Count()</span><br><span class="line">            &#125;)</span><br><span class="line">        .OrderByDescending(x =&gt; x.Count);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//take the first three most liked genress</span></span><br><span class="line">    <span class="keyword">var</span> mostLikedArtists = </span><br><span class="line">        groupedByArtists</span><br><span class="line">            .Take(<span class="number">3</span>)</span><br><span class="line">            .Select(x =&gt; x.ArtistId);    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> _trackRepo.FetchRandomByArtist(mostLikedArtists);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">After implementing another type of playlist generation, users seem to be happy <span class="keyword">with</span> the change. A week later, another feature request comes <span class="keyword">in</span>: users now would like to see a <span class="string">&quot;discovery playlist&quot;</span> generator, which would suggest artists <span class="keyword">and</span> genres the user never upvoted before.  </span><br><span class="line">How can something like <span class="keyword">this</span> be approached? Well, you might decide to create another playlist generator <span class="keyword">class</span> <span class="title">but</span> <span class="title">by</span> <span class="title">now</span> <span class="title">I</span> <span class="title">think</span> <span class="title">you</span> <span class="title">will</span> <span class="title">agree</span> <span class="title">with</span> <span class="title">me</span> <span class="title">that</span> <span class="title">continuing</span> <span class="title">in</span> <span class="title">this</span> <span class="title">way</span> <span class="title">is</span> <span class="title">not</span> <span class="title">scalable</span> <span class="title">in</span> <span class="title">the</span> <span class="title">long</span> <span class="title">term</span>. <span class="title">So</span>, <span class="title">how</span> <span class="title">can</span> <span class="title">we</span> <span class="title">approach</span> <span class="title">this</span>?  </span><br><span class="line"></span><br><span class="line">## <span class="title">Code</span>, <span class="title">meet</span> <span class="title">Template</span> <span class="title">Method</span> <span class="title">Pattern</span></span><br><span class="line"></span><br><span class="line"><span class="title">So</span> <span class="title">what</span> **<span class="title">is</span>** <span class="title">this</span> <span class="title">template</span> <span class="title">pattern</span>? <span class="title">It</span> <span class="title">is</span> <span class="title">basically</span> <span class="title">a</span> <span class="title">fancy</span> <span class="title">way</span> <span class="title">of</span> <span class="title">saying</span> &quot;<span class="title">follow</span> <span class="title">the</span> <span class="title">same</span> <span class="title">damn</span> <span class="title">steps</span> <span class="title">every</span> <span class="title">time</span>.&quot; <span class="title">It</span>&#x27;<span class="title">s</span> <span class="title">like</span> <span class="title">when</span> <span class="title">you</span>&#x27;<span class="title">re</span> <span class="title">making</span> <span class="title">a</span> <span class="title">sandwich</span>, <span class="title">you</span> <span class="title">always</span> <span class="title">put</span> <span class="title">the</span> <span class="title">bread</span> <span class="title">down</span> <span class="title">first</span>, <span class="title">then</span> <span class="title">add</span> <span class="title">some</span> <span class="title">pastrami</span>, <span class="title">Swiss</span> <span class="title">cheese</span>, <span class="title">lettuce</span>, <span class="title">and</span> <span class="title">whatever</span> <span class="title">veggies</span> <span class="title">you</span> <span class="title">happen</span> <span class="title">to</span> <span class="title">like</span>. <span class="title">You</span> <span class="title">don</span>&#x27;<span class="title">t</span> <span class="title">start</span> <span class="title">with</span> <span class="title">the</span> <span class="title">lettuce</span> <span class="title">and</span> <span class="title">end</span> <span class="title">with</span> <span class="title">the</span> <span class="title">bread</span>, <span class="title">that</span>&#x27;<span class="title">s</span> <span class="title">just</span> <span class="title">silly</span>.</span><br><span class="line"></span><br><span class="line"><span class="title">The</span> <span class="title">Template</span> <span class="title">Pattern</span> <span class="title">is</span> <span class="title">all</span> <span class="title">about</span> <span class="title">having</span> <span class="title">a</span> <span class="title">skeleton</span> <span class="title">structure</span> <span class="title">of</span> <span class="title">an</span> <span class="title">algorithm</span> <span class="title">that</span> <span class="title">stays</span> <span class="title">the</span> <span class="title">same</span>, <span class="title">but</span> <span class="title">you</span> <span class="title">can</span> <span class="title">implement</span> <span class="title">the</span> <span class="title">details</span> <span class="title">as</span> <span class="title">needed</span>. <span class="title">So</span>, <span class="title">let</span>&#x27;<span class="title">s</span> <span class="title">say</span> <span class="title">you</span>&#x27;<span class="title">re</span> <span class="title">making</span> <span class="title">different</span> <span class="title">types</span> <span class="title">of</span> <span class="title">sandwiches</span>, <span class="title">you</span> <span class="title">still</span> <span class="title">follow</span> <span class="title">the</span> <span class="title">same</span> <span class="title">bread</span>-<span class="title">meat</span>-<span class="title">cheese</span>-<span class="title">veggies</span> <span class="title">routine</span>, <span class="title">but</span> <span class="title">you</span> <span class="title">might</span> <span class="title">switch</span> <span class="title">out</span> <span class="title">the</span> <span class="title">pastrami</span> <span class="title">for</span> <span class="title">turkey</span> <span class="title">or</span> <span class="title">ham</span>, <span class="title">or</span> <span class="title">swap</span> <span class="title">the</span> &quot;<span class="title">basic</span>&quot; <span class="title">cheese</span> <span class="title">for</span> <span class="title">something</span> <span class="title">fancy</span> <span class="title">like</span> <span class="title">brie</span> <span class="title">or</span> <span class="title">gouda</span>.</span><br><span class="line"></span><br><span class="line"><span class="title">In</span> <span class="title">we</span> <span class="title">talk</span> <span class="title">in</span> <span class="title">code</span> <span class="title">terms</span>, <span class="title">it</span>&#x27;<span class="title">s</span> <span class="title">simply</span> <span class="title">having</span> <span class="title">a</span> <span class="keyword">class</span> <span class="title">that</span> <span class="title">defines</span> <span class="title">some</span> <span class="title">virtual</span> <span class="title">or</span> <span class="title">abstract</span> <span class="title">methods</span> <span class="title">that</span> <span class="title">define</span> <span class="title">the</span> <span class="title">algorithm</span> *<span class="title">steps</span>*, <span class="title">which</span> <span class="title">can</span> <span class="title">be</span> <span class="title">then</span> <span class="title">customized</span> <span class="title">by</span> <span class="title">subclasses</span>. <span class="title">Usually</span>, <span class="title">such</span> <span class="title">a</span> &quot;<span class="title">template</span>&quot; <span class="keyword">class</span> <span class="title">has</span> <span class="title">a</span> <span class="title">bunch</span> <span class="title">of</span> <span class="title">abstract</span> <span class="title">methods</span> <span class="title">and</span> <span class="title">a</span> <span class="title">non</span>-<span class="title">virtual</span> <span class="title">method</span> <span class="title">that</span> <span class="title">defines</span> <span class="title">the</span> <span class="title">structure</span> <span class="title">of</span> <span class="title">the</span> <span class="title">algorithm</span> <span class="title">by</span> <span class="title">using</span> <span class="title">those</span> <span class="title">abstract</span> <span class="title">methods</span>.</span><br><span class="line"></span><br><span class="line">## <span class="title">So</span>, <span class="title">show</span> <span class="title">me</span> <span class="title">the</span> <span class="title">code</span></span><br><span class="line"></span><br><span class="line"><span class="title">Let</span>&#x27;<span class="title">s</span> <span class="title">apply</span> <span class="title">the</span> <span class="title">pattern</span> <span class="title">to</span> <span class="title">the</span> <span class="title">code</span> <span class="title">we</span> <span class="title">have</span> <span class="title">already</span> <span class="title">written</span>. <span class="title">First</span>, <span class="title">let</span>&#x27;<span class="title">s</span> <span class="title">add</span> <span class="title">more</span> &quot;<span class="title">generalized</span>&quot; <span class="title">method</span> <span class="title">to</span> <span class="title">the</span> <span class="title">track</span> <span class="title">repository</span>.</span><br><span class="line"></span><br><span class="line">```<span class="title">cs</span></span><br><span class="line"></span><br><span class="line"><span class="title">public</span> <span class="title">IReadOnlyList</span>&lt;<span class="title">Track</span>&gt; <span class="title">FetchByPredicate</span>(<span class="title">Func</span>&lt;<span class="title">Track</span>, <span class="title">bool</span>&gt; <span class="title">filter</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> _tracks.Where(track =&gt; filter(track))</span><br><span class="line">                .ToList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Now, let’s define a base class that we will use as a “base” for our templates.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">PlaylistGenerator</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">readonly</span> ITrackRepository TrackRepo;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">readonly</span> IVoteRepository VoteRepo;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">PlaylistGenerator</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    ITrackRepository trackRepo, </span></span></span><br><span class="line"><span class="params"><span class="function">    IVoteRepository voteRepo</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    TrackRepo = trackRepo;</span><br><span class="line">    VoteRepo = voteRepo;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">abstract</span> Func&lt;Track, <span class="built_in">bool</span>&gt; PredicateFilter &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IEnumerable&lt;Track&gt; <span class="title">FetchRecommendationFor</span>(<span class="params"><span class="built_in">string</span> userId</span>)</span> =&gt;</span><br><span class="line">     TrackRepo.FetchByPredicate(PredicateFilter);</span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Alright, so now we’ve got a class that fetches recommendations, and we can mess around with how it fetches them by overriding the <code>PredicateFilter</code>. But there is something missing: aggregation. If you take a look at the already implemented playlist generators, you would see the following pattern:</p>
<ol>
<li>Fetch the tracks based on some critera (we just implemented it above)</li>
<li>Aggregate the tracks with “group by” clause and take some random tracks from the aggregated data</li>
</ol>
<p>Sure, we could try to cram both (1) and (2) into the <code>PredicateFilter</code>, but let’s be honest, in a more complex code-base that’s going to turn into a maintenance nightmare after enough time has passed. Instead, let’s modify the abstract class <code>PlaylistGenerator</code> to include the second stage of the algorithm:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">PlaylistGenerator</span>&lt;<span class="title">TAggregationKey</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">readonly</span> ITrackRepository TrackRepo;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">readonly</span> IVoteRepository VoteRepo;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">readonly</span> <span class="built_in">int</span> MaxTrackGroupsToTake;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">readonly</span> <span class="built_in">int</span> MaxResults;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">PlaylistGenerator</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    ITrackRepository trackRepo, </span></span></span><br><span class="line"><span class="params"><span class="function">    IVoteRepository voteRepo,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">int</span> maxTrackGroupsToTake = <span class="number">3</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">int</span> maxResults = <span class="number">100</span></span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    TrackRepo = trackRepo;</span><br><span class="line">    VoteRepo = voteRepo;</span><br><span class="line">    MaxTrackGroupsToTake = maxTrackGroupsToTake;</span><br><span class="line">    MaxResults = maxResults;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">abstract</span> Func&lt;Track, <span class="built_in">bool</span>&gt; PredicateFilter &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">abstract</span> Func&lt;Track, TAggregationKey&gt; AggregationKey &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IEnumerable&lt;Track&gt; <span class="title">FetchRecommendationFor</span>(<span class="params"><span class="built_in">string</span> userId</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">     <span class="keyword">var</span> tracksToAggregate = VoteRepo.FetchByPredicate(PredicateFilter);</span><br><span class="line">     <span class="keyword">var</span> tracksOfGroupedTracks = tracksToAggregate</span><br><span class="line">       .GroupBy(AggregationKey)</span><br><span class="line">       .Take(MaxTrackGroupsToTake)</span><br><span class="line">       .SelectMany(x =&gt; x.Select(g =&gt; g.TrackId));</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> results = TrackRepo</span><br><span class="line">       .FetchByIDs(tracksOfGroupedTracks)</span><br><span class="line">       .OrderBy(Guid.NewGuid())</span><br><span class="line">       .Take(MaxResults)</span><br><span class="line">       .ToList();    </span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> results;   </span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>As we can see, in the <code>FetchRecommendationFor</code> implementation above, we have the algorithm structure unchanging but it can be influenced by override of an abstract properties. Now, all we have left is to implement <code>PlaylistRecommenderByArtistPreferences</code> and <code>PlaylistRecommenderByGenrePreferences</code>.  </p>
<p>Let’s start from <code>PlaylistRecommenderByGenrePreferences</code>:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlaylistRecommenderByGenrePreferences</span>: <span class="title">PlaylistGenerator</span>&lt;<span class="title">MusicGenre</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">string</span> _targetUserId;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">PlaylistRecommenderByGenrePreferences</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    ITrackRepository trackRepo, </span></span></span><br><span class="line"><span class="params"><span class="function">    IVoteRepository voteRepo,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span> targetUserId</span>) : <span class="title">base</span>(<span class="params">trackRepo, voteRepo</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    _targetUserId = targetUserId;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">override</span> Func&lt;Track, <span class="built_in">bool</span>&gt; PredicateFilter</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;      </span><br><span class="line">      <span class="keyword">var</span> userVotes = VoteRepo.FetchUpvotesFor(_targetUserId);   </span><br><span class="line">      <span class="keyword">var</span> trackIds = userVotes.Select(v =&gt; v.TrackId).ToList();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> track =&gt; trackIds.Contains(track.Id);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">override</span> Func&lt;Track, MusicGenre&gt; AggregationKey =&gt; </span><br><span class="line">    (track) =&gt; track.Genre;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Implementing <code>PlaylistRecommenderByArtistPreferences</code> would not be much harder:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlaylistRecommenderByArtistPreferences</span>: <span class="title">PlaylistGenerator</span>&lt;<span class="title">string</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">string</span> _targetUserId;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">PlaylistRecommenderByGenrePreferences</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    ITrackRepository trackRepo, </span></span></span><br><span class="line"><span class="params"><span class="function">    IVoteRepository voteRepo,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">string</span> targetUserId</span>) : <span class="title">base</span>(<span class="params">trackRepo, voteRepo</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    _targetUserId = targetUserId;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">override</span> Func&lt;Track, <span class="built_in">bool</span>&gt; PredicateFilter</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;      </span><br><span class="line">      <span class="keyword">var</span> userVotes = VoteRepo.FetchUpvotesFor(_targetUserId);    </span><br><span class="line">      <span class="keyword">var</span> trackIds = userVotes.Select(v =&gt; v.TrackId).ToList();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> track =&gt; trackIds.Contains(track.Id);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">override</span> Func&lt;Track, <span class="built_in">string</span>&gt; AggregationKey =&gt; </span><br><span class="line">    (track) =&gt; track.ArtistId;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="So-let’s-review-our-epic-battle-with-the-Spaghetti-Monster"><a href="#So-let’s-review-our-epic-battle-with-the-Spaghetti-Monster" class="headerlink" title="So, let’s review our epic battle with the Spaghetti Monster"></a>So, let’s review our epic battle with the Spaghetti Monster</h2><p>We’ve fought with the Spaghetti Monster and emerged victorious. By utilizing the Template Method Pattern, we’ve brought that messy code closer to a well-organized and maintainable piece of art. And yes, I might be exaggerating a bit, but you get the idea.</p>
<p>We have improved:</p>
<ol>
<li>Clarity: Our code is now more readable and easier to understand. No more tangled noodles to decipher!</li>
<li>Stability: By separating the logic into different methods, we’ve reduced the risk of unwanted side effects.</li>
<li>Maintainability: Future updates and changes will be much easier, as each method has a clear purpose and responsibility.</li>
</ol>
<p>So, the next time you find yourself lost in the depths of bad code, remember that the Template Method Pattern may help to disentangle at least <em>some</em> of the mess. May the clean code be with you, and may your sandwiches always be delicious!</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C#</a><a class="post-meta__tags" href="/tags/Architecture/">Architecture</a><a class="post-meta__tags" href="/tags/Programming/">Programming</a><a class="post-meta__tags" href="/tags/Design-Patterns/">Design Patterns</a><a class="post-meta__tags" href="/tags/Gang-Of-Four/">Gang Of Four</a></div><div class="post_share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a></div></div><script async="async" src="https://static.addtoany.com/menu/page.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/11/production-ready/" title="Production-Ready is not just a buzzword"><img class="cover" src="/2023/12/11/production-ready/production_ready_background.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Production-Ready is not just a buzzword</div></div></a></div><div class="next-post pull-right"><a href="/2023/11/14/responsibility-chain/" title="Taming Complexity with Responsibility"><img class="cover" src="/2023/11/14/responsibility-chain/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Taming Complexity with Responsibility</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/1473701" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Michael Yarichuk</div><div class="author-info__description">A place to share steps in my journey to become a better professional</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/myarichuk"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/myarichuk" target="_blank" title=""><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:michael.yarichuk@gmail.com" target="_blank" title=""><i class="fa fa-envelope"></i></a><a class="social-icon" href="https://twitter.com/myarichuk" target="_blank" title=""><i class="fa-brands fa-twitter"></i></a><a class="social-icon" href="https://www.linkedin.com/in/myarichuk/" target="_blank" title=""><i class="fa-brands fa-linkedin"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fa fa-rss"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#The-What-and-Why"><span class="toc-number">1.</span> <span class="toc-text">The What and Why</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-How"><span class="toc-number">2.</span> <span class="toc-text">The How</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#So-let%E2%80%99s-review-our-epic-battle-with-the-Spaghetti-Monster"><span class="toc-number">3.</span> <span class="toc-text">So, let’s review our epic battle with the Spaghetti Monster</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/12/11/production-ready/" title="Production-Ready is not just a buzzword"><img src="/2023/12/11/production-ready/production_ready_background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Production-Ready is not just a buzzword"/></a><div class="content"><a class="title" href="/2023/12/11/production-ready/" title="Production-Ready is not just a buzzword">Production-Ready is not just a buzzword</a><time datetime="2023-12-11T19:15:48.000Z" title="Created 2023-12-11 19:15:48">2023-12-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/14/templates-ftw/" title="Disentangling the Spaghetti Monster"><img src="/2023/11/14/templates-ftw/cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Disentangling the Spaghetti Monster"/></a><div class="content"><a class="title" href="/2023/11/14/templates-ftw/" title="Disentangling the Spaghetti Monster">Disentangling the Spaghetti Monster</a><time datetime="2023-11-14T00:25:27.123Z" title="Created 2023-11-14 00:25:27">2023-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/14/responsibility-chain/" title="Taming Complexity with Responsibility"><img src="/2023/11/14/responsibility-chain/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Taming Complexity with Responsibility"/></a><div class="content"><a class="title" href="/2023/11/14/responsibility-chain/" title="Taming Complexity with Responsibility">Taming Complexity with Responsibility</a><time datetime="2023-11-14T00:25:27.119Z" title="Created 2023-11-14 00:25:27">2023-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/14/ecs-intro/" title="From Inheritance Hell to Component Heaven, the ECS Pattern"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="From Inheritance Hell to Component Heaven, the ECS Pattern"/></a><div class="content"><a class="title" href="/2023/11/14/ecs-intro/" title="From Inheritance Hell to Component Heaven, the ECS Pattern">From Inheritance Hell to Component Heaven, the ECS Pattern</a><time datetime="2023-11-14T00:25:27.115Z" title="Created 2023-11-14 00:25:27">2023-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/04/25/nancyfx-vs-featherhttp/" title="NancyFx vs. FeatherHttp"><img src="/2020/04/25/nancyfx-vs-featherhttp/HTTP_logo.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="NancyFx vs. FeatherHttp"/></a><div class="content"><a class="title" href="/2020/04/25/nancyfx-vs-featherhttp/" title="NancyFx vs. FeatherHttp">NancyFx vs. FeatherHttp</a><time datetime="2020-04-25T09:28:54.000Z" title="Created 2020-04-25 09:28:54">2020-04-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Michael Yarichuk</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.graymatterdeveloper.com/2023/11/14/templates-ftw/'
    this.page.identifier = '/2023/11/14/templates-ftw/'
    this.page.title = 'Disentangling the Spaghetti Monster'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://graymatterdeveloperblog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-R5G4WP4QCQ"></script><script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-R5G4WP4QCQ') </script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>